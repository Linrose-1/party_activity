{"version":3,"file":"upload.js","sources":["utils/upload.js"],"sourcesContent":["/**\r\n * uploadFile.js\r\n * \r\n * 一个基于“预签名URL”模式的文件上传模块。\r\n * 它会依次执行：\r\n * 1. 从后端获取上传许可（预签名URL）。\r\n * 2. 将文件直接上传到云存储。\r\n * 3. 【新增】调用后端接口对上传成功的图片进行安全检查。\r\n */\r\n\r\n// 1. 导入您项目中封装好的 request 函数\r\nimport request from '@/utils/request.js';\r\n\r\n// 2. 封装一个 FileApi 对象来管理文件相关的后端接口调用\r\nconst FileApi = {\r\n\t/**\r\n\t * 从后端获取文件的预签名上传地址\r\n\t */\r\n\tgetFilePresignedUrl: (fileName, directory) => {\r\n\t\treturn request('/app-api/infra/file/presigned-url', {\r\n\t\t\tmethod: 'GET',\r\n\t\t\tdata: {\r\n\t\t\t\tname: fileName,\r\n\t\t\t\tdirectory: directory,\r\n\t\t\t}\r\n\t\t});\r\n\t},\r\n\r\n\t/**\r\n\t * 【新增】调用后端接口检查图片内容是否合规\r\n\t * @param {string} url - 要检查的图片的URL\r\n\t * @returns {Promise<{data: any, error: string|null}>}\r\n\t */\r\n\tcheckImage: (url) => {\r\n\t\treturn request('/app-api/infra/file/check-img', {\r\n\t\t\tmethod: 'GET',\r\n\t\t\tdata: {\r\n\t\t\t\timgUrl: url // 根据接口文档，参数名为 imgUrl\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n};\r\n\r\n/**\r\n * 封装文件上传（预签名URL模式 + 安全检查）\r\n *\r\n * ... (JSDoc 注释保持不变) ...\r\n */\r\nconst uploadFile = async (file, options = {}) => {\r\n\t// ------------------- 1. 参数校验和准备 (无变化) -------------------\r\n\tif (!file || !file.path) {\r\n\t\tconst errorMsg = '未提供有效的文件对象（缺少 path 属性）';\r\n\t\tconsole.error('uploadFile Error:', errorMsg);\r\n\t\treturn {\r\n\t\t\tdata: null,\r\n\t\t\terror: errorMsg\r\n\t\t};\r\n\t}\r\n\tconst fileName = file.name || file.path.substring(file.path.lastIndexOf('/') + 1);\r\n\tconst fileType = file.type || 'application/octet-stream';\r\n\tconst {\r\n\t\tdirectory = ''\r\n\t} = options;\r\n\r\n\t// ------------------- 2. 获取预签名URL (无变化) -------------------\r\n\tconst {\r\n\t\tdata: presignedInfo,\r\n\t\terror: getUrlError\r\n\t} = await FileApi.getFilePresignedUrl(fileName, directory);\r\n\tif (getUrlError) {\r\n\t\tconsole.error('获取预签名URL失败:', getUrlError);\r\n\t\treturn {\r\n\t\t\tdata: null,\r\n\t\t\terror: getUrlError\r\n\t\t};\r\n\t}\r\n\r\n\t// ------------------- 3. 读取文件本地二进制数据 (无变化) -------------------\r\n\tconst fileBufferResult = await new Promise(resolve => {\r\n\t\tuni.getFileSystemManager().readFile({\r\n\t\t\tfilePath: file.path,\r\n\t\t\tsuccess: res => resolve({\r\n\t\t\t\tdata: res.data,\r\n\t\t\t\terror: null\r\n\t\t\t}),\r\n\t\t\tfail: err => resolve({\r\n\t\t\t\tdata: null,\r\n\t\t\t\terror: err.errMsg || '读取本地文件失败'\r\n\t\t\t}),\r\n\t\t});\r\n\t});\r\n\tif (fileBufferResult.error) {\r\n\t\tconsole.error('读取本地文件失败:', fileBufferResult.error);\r\n\t\treturn {\r\n\t\t\tdata: null,\r\n\t\t\terror: fileBufferResult.error\r\n\t\t};\r\n\t}\r\n\tconst fileBuffer = fileBufferResult.data;\r\n\r\n\t// ------------------- 4. 上传文件到云存储 (无变化) -------------------\r\n\ttry {\r\n\t\tawait new Promise((resolve, reject) => {\r\n\t\t\tuni.request({\r\n\t\t\t\turl: presignedInfo.uploadUrl,\r\n\t\t\t\tmethod: 'PUT',\r\n\t\t\t\theader: {\r\n\t\t\t\t\t'Content-Type': fileType\r\n\t\t\t\t},\r\n\t\t\t\tdata: fileBuffer,\r\n\t\t\t\tsuccess: res => {\r\n\t\t\t\t\tif (res.statusCode >= 200 && res.statusCode < 300) {\r\n\t\t\t\t\t\tresolve(res);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treject(new Error(`云存储上传失败，状态码: ${res.statusCode}`));\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\tfail: err => reject(err),\r\n\t\t\t});\r\n\t\t});\r\n\t} catch (err) {\r\n\t\tconsole.error('上传文件到云存储异常:', err);\r\n\t\treturn {\r\n\t\t\tdata: null,\r\n\t\t\terror: err.message || '文件上传到云端失败'\r\n\t\t};\r\n\t}\r\n\r\n\t// ------------------- 5. 【新增】调用接口进行图片安全检查 -------------------\r\n\t// 只有当文件是图片类型时，才进行检查。可以根据需要调整这个判断逻辑。\r\n\ttry {\r\n\t\tconsole.log(`[准备检查图片] URL: ${presignedInfo.url}`);\r\n\r\n\t\tconst {\r\n\t\t\terror: checkError\r\n\t\t} = await FileApi.checkImage(presignedInfo.url);\r\n\r\n\t\t// 【在这里也加上日志】\r\n\t\tconsole.log('[图片检查完成] 返回的错误信息:', checkError);\r\n\r\n\t\tif (checkError) {\r\n\t\t\tconsole.warn('文件安全检查未通过:', checkError);\r\n\t\t\treturn {\r\n\t\t\t\tdata: null,\r\n\t\t\t\terror: `内容违规: ${checkError}`\r\n\t\t\t};\r\n\t\t}\r\n\t} catch (err) {\r\n\t\tconsole.error('调用安全检查接口时发生异常:', err);\r\n\t\treturn {\r\n\t\t\tdata: null,\r\n\t\t\terror: '文件安全检查失败'\r\n\t\t};\r\n\t}\r\n\r\n\t// ------------------- 6. 返回最终结果 -------------------\r\n\t// 如果所有步骤都成功，返回最终可访问的 URL\r\n\treturn {\r\n\t\tdata: presignedInfo.url,\r\n\t\terror: null\r\n\t};\r\n};\r\n\r\n// 将核心函数导出\r\nexport default uploadFile;"],"names":["request","uni"],"mappings":";;;AAcA,MAAM,UAAU;AAAA;AAAA;AAAA;AAAA,EAIf,qBAAqB,CAAC,UAAU,cAAc;AAC7C,WAAOA,cAAAA,QAAQ,qCAAqC;AAAA,MACnD,QAAQ;AAAA,MACR,MAAM;AAAA,QACL,MAAM;AAAA,QACN;AAAA,MACA;AAAA,IACJ,CAAG;AAAA,EACD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOD,YAAY,CAAC,QAAQ;AACpB,WAAOA,cAAAA,QAAQ,iCAAiC;AAAA,MAC/C,QAAQ;AAAA,MACR,MAAM;AAAA,QACL,QAAQ;AAAA;AAAA,MACR;AAAA,IACJ,CAAG;AAAA,EACD;AACF;AAOK,MAAC,aAAa,OAAO,MAAM,UAAU,OAAO;AAEhD,MAAI,CAAC,QAAQ,CAAC,KAAK,MAAM;AACxB,UAAM,WAAW;AACjBC,kBAAA,MAAA,MAAA,SAAA,yBAAc,qBAAqB,QAAQ;AAC3C,WAAO;AAAA,MACN,MAAM;AAAA,MACN,OAAO;AAAA,IACV;AAAA,EACE;AACD,QAAM,WAAW,KAAK,QAAQ,KAAK,KAAK,UAAU,KAAK,KAAK,YAAY,GAAG,IAAI,CAAC;AAChF,QAAM,WAAW,KAAK,QAAQ;AAC9B,QAAM;AAAA,IACL,YAAY;AAAA,EACZ,IAAG;AAGJ,QAAM;AAAA,IACL,MAAM;AAAA,IACN,OAAO;AAAA,EACP,IAAG,MAAM,QAAQ,oBAAoB,UAAU,SAAS;AACzD,MAAI,aAAa;AAChBA,kBAAA,MAAA,MAAA,SAAA,yBAAc,eAAe,WAAW;AACxC,WAAO;AAAA,MACN,MAAM;AAAA,MACN,OAAO;AAAA,IACV;AAAA,EACE;AAGD,QAAM,mBAAmB,MAAM,IAAI,QAAQ,aAAW;AACrDA,wBAAI,qBAAsB,EAAC,SAAS;AAAA,MACnC,UAAU,KAAK;AAAA,MACf,SAAS,SAAO,QAAQ;AAAA,QACvB,MAAM,IAAI;AAAA,QACV,OAAO;AAAA,MACX,CAAI;AAAA,MACD,MAAM,SAAO,QAAQ;AAAA,QACpB,MAAM;AAAA,QACN,OAAO,IAAI,UAAU;AAAA,MACzB,CAAI;AAAA,IACJ,CAAG;AAAA,EACH,CAAE;AACD,MAAI,iBAAiB,OAAO;AAC3BA,kBAAc,MAAA,MAAA,SAAA,yBAAA,aAAa,iBAAiB,KAAK;AACjD,WAAO;AAAA,MACN,MAAM;AAAA,MACN,OAAO,iBAAiB;AAAA,IAC3B;AAAA,EACE;AACD,QAAM,aAAa,iBAAiB;AAGpC,MAAI;AACH,UAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtCA,oBAAAA,MAAI,QAAQ;AAAA,QACX,KAAK,cAAc;AAAA,QACnB,QAAQ;AAAA,QACR,QAAQ;AAAA,UACP,gBAAgB;AAAA,QAChB;AAAA,QACD,MAAM;AAAA,QACN,SAAS,SAAO;AACf,cAAI,IAAI,cAAc,OAAO,IAAI,aAAa,KAAK;AAClD,oBAAQ,GAAG;AAAA,UACjB,OAAY;AACN,mBAAO,IAAI,MAAM,gBAAgB,IAAI,UAAU,EAAE,CAAC;AAAA,UAClD;AAAA,QACD;AAAA,QACD,MAAM,SAAO,OAAO,GAAG;AAAA,MAC3B,CAAI;AAAA,IACJ,CAAG;AAAA,EACD,SAAQ,KAAK;AACbA,iEAAc,eAAe,GAAG;AAChC,WAAO;AAAA,MACN,MAAM;AAAA,MACN,OAAO,IAAI,WAAW;AAAA,IACzB;AAAA,EACE;AAID,MAAI;AACHA,wBAAY,MAAA,OAAA,0BAAA,iBAAiB,cAAc,GAAG,EAAE;AAEhD,UAAM;AAAA,MACL,OAAO;AAAA,IACP,IAAG,MAAM,QAAQ,WAAW,cAAc,GAAG;AAG9CA,kBAAA,MAAA,MAAA,OAAA,0BAAY,qBAAqB,UAAU;AAE3C,QAAI,YAAY;AACfA,oBAAa,MAAA,MAAA,QAAA,0BAAA,cAAc,UAAU;AACrC,aAAO;AAAA,QACN,MAAM;AAAA,QACN,OAAO,SAAS,UAAU;AAAA,MAC9B;AAAA,IACG;AAAA,EACD,SAAQ,KAAK;AACbA,kBAAc,MAAA,MAAA,SAAA,0BAAA,kBAAkB,GAAG;AACnC,WAAO;AAAA,MACN,MAAM;AAAA,MACN,OAAO;AAAA,IACV;AAAA,EACE;AAID,SAAO;AAAA,IACN,MAAM,cAAc;AAAA,IACpB,OAAO;AAAA,EACT;AACA;;"}