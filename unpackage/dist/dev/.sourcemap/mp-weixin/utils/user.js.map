{"version":3,"file":"user.js","sources":["utils/user.js"],"sourcesContent":["// src/utils/user.js\r\nimport request from '@/utils/request.js';\r\n\r\n/**\r\n * @description ‰ªéÊú¨Âú∞ÁºìÂ≠ò‰∏≠Ëé∑ÂèñËß£ÊûêÂêéÁöÑÁî®Êà∑‰ø°ÊÅØÂØπË±°\r\n * @returns {object|null} Áî®Êà∑‰ø°ÊÅØÂØπË±°Êàñ null\r\n */\r\nexport function getCachedUserInfo() {\r\n\tconst userInfoStr = uni.getStorageSync('userInfo');\r\n\tif (userInfoStr) {\r\n\t\ttry {\r\n\t\t\treturn JSON.parse(userInfoStr);\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error('Ëß£ÊûêÁºìÂ≠òÁöÑÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', e);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\treturn null;\r\n}\r\n\r\n/**\r\n * @description ‰ªéÊú¨Âú∞ÁºìÂ≠ò‰∏≠Áõ¥Êé•Ëé∑ÂèñÁî®Êà∑ÁöÑÈÇÄËØ∑Á†Å\r\n * @returns {string} ÈÇÄËØ∑Á†ÅÊàñÁ©∫Â≠óÁ¨¶‰∏≤\r\n */\r\nexport function getInviteCode() {\r\n\tconst userInfo = getCachedUserInfo();\r\n\treturn userInfo ? userInfo.shardCode || '' : '';\r\n}\r\n\r\n/**\r\n * @description Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÂÆåÊï¥ÁôªÂΩïÔºàÂøÖÈ°ªÂåÖÂê´userId‰∏îÂ∑≤ÁªëÂÆöÊâãÊú∫Âè∑Ôºâ\r\n * @returns {boolean} true=Â∑≤ÂÆåÊï¥ÁôªÂΩï, false=Êú™ÁôªÂΩïÊàñ‰ªÖÈùôÈªòÁôªÂΩï\r\n */\r\nexport function isUserFullyLoggedIn() {\r\n\t// 1. Ê£ÄÊü•ÊòØÂê¶Êúâ token/userId (Âü∫Á°ÄÁôªÂΩïÁä∂ÊÄÅ)\r\n\tconst userId = uni.getStorageSync('userId');\r\n\tconst token = uni.getStorageSync('token');\r\n\tif (!userId || !token) {\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// 2. Ê£ÄÊü•Áî®Êà∑‰ø°ÊÅØ‰∏≠ÊòØÂê¶ÊúâÊâãÊú∫Âè∑\r\n\tconst userInfo = getCachedUserInfo();\r\n\tif (!userInfo || !userInfo.mobile) {\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\n// /**\r\n//  * @description Áªü‰∏ÄÁöÑÁôªÂΩïÊùÉÈôêÊ†°È™åÂç´Â£´\r\n//  * Â¶ÇÊûúÊú™ÂÆåÊï¥ÁôªÂΩïÔºåËá™Âä®ÂºπÂá∫ÊèêÁ§∫Ê°ÜÂπ∂ÂºïÂØºÂéªÁôªÂΩïÈ°µ„ÄÇ\r\n//  * @param {string} content - ÂºπÁ™óÊèêÁ§∫ÊñáÊ°àÔºåÈªòËÆ§‰∏∫Ê†áÂáÜËØùÊúØ\r\n//  * @returns {boolean} true=Ê†°È™åÈÄöËøá, false=Ê†°È™å‰∏çÈÄöËøá(Â∑≤ÂºπÁ™ó)\r\n//  */\r\n// export function checkLoginGuard(content = 'ËØ•ÂäüËÉΩÈúÄË¶ÅÊÇ®ÂÆåÂñÑÁôªÂΩï‰ø°ÊÅØÔºàÁªëÂÆöÊâãÊú∫Âè∑ÔºâÂêéÊâçËÉΩ‰ΩøÁî®ÔºåÊòØÂê¶Á´ãÂç≥ÂâçÂæÄÁôªÂΩïÔºü') {\r\n// \tif (isUserFullyLoggedIn()) {\r\n// \t\treturn true;\r\n// \t}\r\n\r\n// \t// Ê†°È™åÊú™ÈÄöËøáÔºåÂºπÂá∫ÂºïÂØºÁ™ó\r\n// \tuni.showModal({\r\n// \t\ttitle: 'Ê∏©È¶®ÊèêÁ§∫',\r\n// \t\tcontent: content,\r\n// \t\tconfirmText: 'ÂéªÁôªÂΩï',\r\n// \t\tcancelText: 'ÂÜçÈÄõÈÄõ',\r\n// \t\tconfirmColor: '#FF6A00',\r\n// \t\tsuccess: (res) => {\r\n// \t\t\tif (res.confirm) {\r\n// \t\t\t\tuni.navigateTo({\r\n// \t\t\t\t\turl: '/pages/index/index'\r\n// \t\t\t\t});\r\n// \t\t\t}\r\n// \t\t}\r\n// \t});\r\n\r\n// \treturn false;\r\n// }\r\n\r\n/**\r\n * @description Êô∫ËÉΩÁôªÂΩïÊùÉÈôêÊ†°È™åÂç´Â£´ (Async)\r\n * 1. Ê£ÄÊü•Êú¨Âú∞ÊòØÂê¶Â∑≤ÂÆåÊï¥ÁôªÂΩï -> ÊòØÔºöÊîæË°å (true)\r\n * 2. Â∞ùËØïÈùôÈªòÁôªÂΩïËé∑Âèñ Token\r\n * 3. Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÊ£ÄÊü•ÊòØÂê¶ÁªëÂÆö -> ÊòØÔºöÂ≠òÁºìÂ≠òÔºåÊîæË°å (true)\r\n * 4. Âê¶ÔºöÂºπÁ™óÂºïÂØºÂéªÁªëÂÆöÈ°µ -> Êã¶Êà™ (false)\r\n * \r\n * @param {string} content - ÂºπÁ™óÊèêÁ§∫ÊñáÊ°à\r\n * @returns {Promise<boolean>} true=Ê†°È™åÈÄöËøá/Â∑≤Ëá™Âä®ÁôªÂΩï, false=Ê†°È™å‰∏çÈÄöËøá(Â∑≤ÂºπÁ™ó)\r\n */\r\nexport async function checkLoginGuard(content = 'ËØ•ÂäüËÉΩÈúÄË¶ÅÊÇ®ÂÆåÂñÑÁôªÂΩï‰ø°ÊÅØÔºàÁªëÂÆöÊâãÊú∫Âè∑ÔºâÂêéÊâçËÉΩ‰ΩøÁî®ÔºåÊòØÂê¶Á´ãÂç≥ÂâçÂæÄÁôªÂΩïÔºü') {\r\n\t// 1. Á¨¨‰∏ÄÈÅìÈò≤Á∫øÔºöÊú¨Âú∞ÁºìÂ≠òÊ£ÄÊü•\r\n\t// Â¶ÇÊûúÊú¨Âú∞Â∑≤ÁªèÊúâ Token ‰∏îÊúâÊâãÊú∫Âè∑ÔºåÁõ¥Êé•ÊîæË°åÔºåÈÄüÂ∫¶ÊúÄÂø´\r\n\tif (isUserFullyLoggedIn()) {\r\n\t\treturn true;\r\n\t}\r\n\r\n\t// 2. Á¨¨‰∫åÈÅìÈò≤Á∫øÔºöÂ∞ùËØïÈùôÈªòÁôªÂΩïË°•Êïë\r\n\t// (Âç≥‰ΩøÁî®Êà∑Êú¨Âú∞Ê≤° TokenÔºåÊàñËÄÖÊúâ Token ‰ΩÜÊ≤°ÊâãÊú∫Âè∑ÔºåÊàë‰ª¨ÈÉΩËØïÁùÄÂéªÂêéÁ´ØÈóÆÈóÆ‚ÄúÊàëÊòØ‰∏çÊòØËÄÅÁî®Êà∑Ôºü‚Äù)\r\n\r\n\tuni.showLoading({\r\n\t\ttitle: 'Ê£ÄÊü•Ë∫´‰ªΩ...',\r\n\t\tmask: true\r\n\t});\r\n\r\n\ttry {\r\n\t\t// 2.1 ÊâßË°åÈùôÈªòÁôªÂΩïÊãø Token\r\n\t\t// ËøôÈáåÂ§çÁî® globalSilentLogin ÊàñËÄÖÁõ¥Êé•ÂÜôÈÄªËæëÔºå‰∏∫‰∫ÜÁã¨Á´ãÊÄßÔºåËøôÈáåÂÜô‰∏™Á≤æÁÆÄÁâà\r\n\t\tconst loginRes = await uni.login({\r\n\t\t\tprovider: 'weixin'\r\n\t\t});\r\n\t\tif (loginRes.code) {\r\n\t\t\tconst pendingInviteCode = uni.getStorageSync('pendingInviteCode');\r\n\t\t\tconst {\r\n\t\t\t\tdata: loginData,\r\n\t\t\t\terror: loginError\r\n\t\t\t} = await request('/app-api/member/auth/weixin-mini-app-login', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tloginCode: loginRes.code,\r\n\t\t\t\t\tstate: 'default',\r\n\t\t\t\t\tshardCode: pendingInviteCode || ''\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tif (!loginError && loginData && loginData.accessToken) {\r\n\t\t\t\t// Â≠ò Token\r\n\t\t\t\tuni.setStorageSync('token', loginData.accessToken);\r\n\t\t\t\tuni.setStorageSync('userId', loginData.userId);\r\n\r\n\t\t\t\t// 2.2 ÊãøÂà∞ Token ÂêéÔºåÁ´ãÂç≥Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÔºåÊ£ÄÊü•ÊòØÂê¶ÁªëÂÆö‰∫ÜÊâãÊú∫Âè∑\r\n\t\t\t\tconst {\r\n\t\t\t\t\tdata: userData,\r\n\t\t\t\t\terror: userError\r\n\t\t\t\t} = await request('/app-api/member/user/get', {\r\n\t\t\t\t\tmethod: 'GET'\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (!userError && userData) {\r\n\t\t\t\t\t// Â≠òÁî®Êà∑‰ø°ÊÅØ\r\n\t\t\t\t\tuni.setStorageSync('userInfo', JSON.stringify(userData));\r\n\r\n\t\t\t\t\t// „ÄêÂÖ≥ÈîÆÂà§Êñ≠„ÄëÔºöÊòØËÄÅÁî®Êà∑ÂêóÔºü(ÊúâÊâãÊú∫Âè∑)\r\n\t\t\t\t\tif (userData.mobile) {\r\n\t\t\t\t\t\tuni.hideLoading();\r\n\t\t\t\t\t\t// ÊòØËÄÅÁî®Êà∑ÔºåÁõ¥Êé•ÊîæË°åÔºÅ\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t} catch (e) {\r\n\t\tconsole.error('ÂÆàÂç´Ê£ÄÊµãÂºÇÂ∏∏:', e);\r\n\t} finally {\r\n\t\tuni.hideLoading();\r\n\t}\r\n\r\n\t// 3. Á¨¨‰∏âÈÅìÈò≤Á∫øÔºöÁ°ÆÂÆûÊòØÊñ∞Áî®Êà∑ÔºàÊàñËÄÖÊé•Âè£ÊåÇ‰∫ÜÔºâÔºåÂºπÁ™óÂºïÂØº\r\n\t// Âè™ÊúâÂà∞‰∫ÜËøô‰∏ÄÊ≠•ÔºåÊâçËÆ§‰∏∫‚ÄúÁúüÁöÑÈúÄË¶ÅÂéªÁªëÂÆö‰∫Ü‚Äù\r\n\tuni.showModal({\r\n\t\ttitle: 'Ê∏©È¶®ÊèêÁ§∫',\r\n\t\tcontent: content,\r\n\t\tconfirmText: 'ÂéªÁôªÂΩï',\r\n\t\tcancelText: 'ÂÜçÈÄõÈÄõ',\r\n\t\tconfirmColor: '#FF6A00',\r\n\t\tsuccess: (res) => {\r\n\t\t\tif (res.confirm) {\r\n\t\t\t\tuni.navigateTo({\r\n\t\t\t\t\turl: '/pages/index/index'\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\treturn false;\r\n}\r\n\r\nlet loginPromise = null;\r\n\r\n/**\r\n * ÂÖ®Â±ÄÈùôÈªòÁôªÂΩïÊñπÊ≥ï\r\n * ‰ªª‰ΩïÈ°µÈù¢Ë∞ÉÁî®ÂÆÉÔºåÈÉΩ‰ºöÂ§çÁî®Âêå‰∏Ä‰∏™ËØ∑Ê±ÇÔºåÈÅøÂÖçÂπ∂ÂèëÈáçÂ§çÁôªÂΩï\r\n */\r\nexport async function globalSilentLogin() {\r\n\t// 1. Â¶ÇÊûúÂ∑≤Êúâ TokenÔºåÁõ¥Êé•ËøîÂõûÊàêÂäü\r\n\tif (uni.getStorageSync('token')) {\r\n\t\treturn true;\r\n\t}\r\n\r\n\t// 2. Â¶ÇÊûúÊ≠£Âú®ÁôªÂΩï‰∏≠ÔºåËøîÂõûÂêå‰∏Ä‰∏™ Promise\r\n\tif (loginPromise) {\r\n\t\treturn loginPromise;\r\n\t}\r\n\r\n\t// 3. ÂºÄÂßãÊñ∞ÁöÑÁôªÂΩïÊµÅÁ®ã\r\n\tloginPromise = new Promise(async (resolve) => {\r\n\t\tconsole.log('üöÄ [Global] ÂºÄÂßãÂÖ®Â±ÄÈùôÈªòÁôªÂΩï...');\r\n\t\ttry {\r\n\t\t\tconst loginRes = await uni.login({\r\n\t\t\t\tprovider: 'weixin'\r\n\t\t\t});\r\n\t\t\tif (loginRes.code) {\r\n\t\t\t\t// ÂºïÂÖ• request (Ê≥®ÊÑèÂæ™ÁéØ‰æùËµñÔºåÂ¶ÇÊûú request ‰πüÂºï‰∫Ü user.jsÔºåË¶ÅÂ∞èÂøÉ)\r\n\t\t\t\t// ËøôÈáåÂª∫ËÆÆÊää request ÈÄªËæëÂÜÖËÅîÊàñËÄÖÁ°Æ‰øùËß£ËÄ¶\r\n\t\t\t\t// ÁÆÄÂçïËµ∑ËßÅÔºåÂÅáËÆæ request ÂèØÁî®\r\n\t\t\t\tconst {\r\n\t\t\t\t\trequest\r\n\t\t\t\t} = require('./request.js'); // Âä®ÊÄÅÂºïÂÖ•Èò≤Âæ™ÁéØ\r\n\r\n\t\t\t\tconst pendingInviteCode = uni.getStorageSync('pendingInviteCode');\r\n\t\t\t\tconst {\r\n\t\t\t\t\tdata\r\n\t\t\t\t} = await request('/app-api/member/auth/weixin-mini-app-login', {\r\n\t\t\t\t\tmethod: 'POST',\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\tloginCode: loginRes.code,\r\n\t\t\t\t\t\tstate: 'default',\r\n\t\t\t\t\t\tshardCode: pendingInviteCode || ''\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (data && data.accessToken) {\r\n\t\t\t\t\tuni.setStorageSync('token', data.accessToken);\r\n\t\t\t\t\tuni.setStorageSync('userId', data.userId);\r\n\t\t\t\t\tconsole.log('‚úÖ [Global] ÈùôÈªòÁôªÂΩïÊàêÂäü');\r\n\t\t\t\t\tresolve(true);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error('‚ùå [Global] ÈùôÈªòÁôªÂΩïÂ§±Ë¥•', e);\r\n\t\t} finally {\r\n\t\t\tloginPromise = null; // ÁªìÊùüÂêéÊ∏ÖÁ©∫ÈîÅ\r\n\t\t}\r\n\t\tresolve(false);\r\n\t});\r\n\r\n\treturn loginPromise;\r\n}"],"names":["uni","request"],"mappings":"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"}