{"version":3,"file":"user.js","sources":["utils/user.js"],"sourcesContent":["// src/utils/user.js\r\n\r\n/**\r\n * @description 从本地缓存中获取解析后的用户信息对象\r\n * @returns {object|null} 用户信息对象或 null\r\n */\r\nexport function getCachedUserInfo() {\r\n\tconst userInfoStr = uni.getStorageSync('userInfo');\r\n\tif (userInfoStr) {\r\n\t\ttry {\r\n\t\t\treturn JSON.parse(userInfoStr);\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error('解析缓存的用户信息失败:', e);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\treturn null;\r\n}\r\n\r\n/**\r\n * @description 从本地缓存中直接获取用户的邀请码\r\n * @returns {string} 邀请码或空字符串\r\n */\r\nexport function getInviteCode() {\r\n\tconst userInfo = getCachedUserInfo();\r\n\treturn userInfo ? userInfo.shardCode || '' : '';\r\n}\r\n\r\n/**\r\n * @description 检查用户是否已完整登录（必须包含userId且已绑定手机号）\r\n * @returns {boolean} true=已完整登录, false=未登录或仅静默登录\r\n */\r\nexport function isUserFullyLoggedIn() {\r\n\t// 1. 检查是否有 token/userId (基础登录状态)\r\n\tconst userId = uni.getStorageSync('userId');\r\n\tconst token = uni.getStorageSync('token');\r\n\tif (!userId || !token) {\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// 2. 检查用户信息中是否有手机号\r\n\tconst userInfo = getCachedUserInfo(); \r\n\tif (!userInfo || !userInfo.mobile) {\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\n/**\r\n * @description 统一的登录权限校验卫士\r\n * 如果未完整登录，自动弹出提示框并引导去登录页。\r\n * @param {string} content - 弹窗提示文案，默认为标准话术\r\n * @returns {boolean} true=校验通过, false=校验不通过(已弹窗)\r\n */\r\nexport function checkLoginGuard(content = '该功能需要您完善登录信息（绑定手机号）后才能使用，是否立即前往登录？') {\r\n\tif (isUserFullyLoggedIn()) {\r\n\t\treturn true;\r\n\t}\r\n\r\n\t// 校验未通过，弹出引导窗\r\n\tuni.showModal({\r\n\t\ttitle: '温馨提示',\r\n\t\tcontent: content,\r\n\t\tconfirmText: '去登录',\r\n\t\tcancelText: '再逛逛',\r\n\t\tconfirmColor: '#FF6A00',\r\n\t\tsuccess: (res) => {\r\n\t\t\tif (res.confirm) {\r\n\t\t\t\tuni.navigateTo({\r\n\t\t\t\t\turl: '/pages/index/index'\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\treturn false;\r\n}\r\n\r\n\r\n\r\n// utils/user.js\r\n\r\nlet loginPromise = null;\r\n\r\n/**\r\n * 全局静默登录方法\r\n * 任何页面调用它，都会复用同一个请求，避免并发重复登录\r\n */\r\nexport async function globalSilentLogin() {\r\n\t// 1. 如果已有 Token，直接返回成功\r\n\tif (uni.getStorageSync('token')) {\r\n\t\treturn true;\r\n\t}\r\n\r\n\t// 2. 如果正在登录中，返回同一个 Promise\r\n\tif (loginPromise) {\r\n\t\treturn loginPromise;\r\n\t}\r\n\r\n\t// 3. 开始新的登录流程\r\n\tloginPromise = new Promise(async (resolve) => {\r\n\t\tconsole.log('🚀 [Global] 开始全局静默登录...');\r\n\t\ttry {\r\n\t\t\tconst loginRes = await uni.login({\r\n\t\t\t\tprovider: 'weixin'\r\n\t\t\t});\r\n\t\t\tif (loginRes.code) {\r\n\t\t\t\t// 引入 request (注意循环依赖，如果 request 也引了 user.js，要小心)\r\n\t\t\t\t// 这里建议把 request 逻辑内联或者确保解耦\r\n\t\t\t\t// 简单起见，假设 request 可用\r\n\t\t\t\tconst {\r\n\t\t\t\t\trequest\r\n\t\t\t\t} = require('./request.js'); // 动态引入防循环\r\n\r\n\t\t\t\tconst pendingInviteCode = uni.getStorageSync('pendingInviteCode');\r\n\t\t\t\tconst {\r\n\t\t\t\t\tdata\r\n\t\t\t\t} = await request('/app-api/member/auth/weixin-mini-app-login', {\r\n\t\t\t\t\tmethod: 'POST',\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\tloginCode: loginRes.code,\r\n\t\t\t\t\t\tstate: 'default',\r\n\t\t\t\t\t\tshardCode: pendingInviteCode || ''\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (data && data.accessToken) {\r\n\t\t\t\t\tuni.setStorageSync('token', data.accessToken);\r\n\t\t\t\t\tuni.setStorageSync('userId', data.userId);\r\n\t\t\t\t\tconsole.log('✅ [Global] 静默登录成功');\r\n\t\t\t\t\tresolve(true);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error('❌ [Global] 静默登录失败', e);\r\n\t\t} finally {\r\n\t\t\tloginPromise = null; // 结束后清空锁\r\n\t\t}\r\n\t\tresolve(false);\r\n\t});\r\n\r\n\treturn loginPromise;\r\n}"],"names":["uni"],"mappings":";;AAMO,SAAS,oBAAoB;AACnC,QAAM,cAAcA,cAAAA,MAAI,eAAe,UAAU;AACjD,MAAI,aAAa;AAChB,QAAI;AACH,aAAO,KAAK,MAAM,WAAW;AAAA,IAC7B,SAAQ,GAAG;AACXA,oBAAc,MAAA,MAAA,SAAA,uBAAA,gBAAgB,CAAC;AAC/B,aAAO;AAAA,IACP;AAAA,EACD;AACD,SAAO;AACR;AAMO,SAAS,gBAAgB;AAC/B,QAAM,WAAW;AACjB,SAAO,WAAW,SAAS,aAAa,KAAK;AAC9C;AAMO,SAAS,sBAAsB;AAErC,QAAM,SAASA,cAAAA,MAAI,eAAe,QAAQ;AAC1C,QAAM,QAAQA,cAAAA,MAAI,eAAe,OAAO;AACxC,MAAI,CAAC,UAAU,CAAC,OAAO;AACtB,WAAO;AAAA,EACP;AAGD,QAAM,WAAW;AACjB,MAAI,CAAC,YAAY,CAAC,SAAS,QAAQ;AAClC,WAAO;AAAA,EACP;AAED,SAAO;AACR;AAQO,SAAS,gBAAgB,UAAU,sCAAsC;AAC/E,MAAI,oBAAmB,GAAI;AAC1B,WAAO;AAAA,EACP;AAGDA,gBAAAA,MAAI,UAAU;AAAA,IACb,OAAO;AAAA,IACP;AAAA,IACA,aAAa;AAAA,IACb,YAAY;AAAA,IACZ,cAAc;AAAA,IACd,SAAS,CAAC,QAAQ;AACjB,UAAI,IAAI,SAAS;AAChBA,sBAAAA,MAAI,WAAW;AAAA,UACd,KAAK;AAAA,QACV,CAAK;AAAA,MACD;AAAA,IACD;AAAA,EACH,CAAE;AAED,SAAO;AACR;AAMA,IAAI,eAAe;AAMZ,eAAe,oBAAoB;AAEzC,MAAIA,cAAG,MAAC,eAAe,OAAO,GAAG;AAChC,WAAO;AAAA,EACP;AAGD,MAAI,cAAc;AACjB,WAAO;AAAA,EACP;AAGD,iBAAe,IAAI,QAAQ,OAAO,YAAY;AAC7CA,kBAAAA,MAAA,MAAA,OAAA,wBAAY,yBAAyB;AACrC,QAAI;AACH,YAAM,WAAW,MAAMA,cAAG,MAAC,MAAM;AAAA,QAChC,UAAU;AAAA,MACd,CAAI;AACD,UAAI,SAAS,MAAM;AAIlB,cAAM;AAAA,UACL;AAAA,QACL,IAAQ,QAAQ,cAAc;AAE1B,cAAM,oBAAoBA,cAAAA,MAAI,eAAe,mBAAmB;AAChE,cAAM;AAAA,UACL;AAAA,QACL,IAAQ,MAAM,QAAQ,8CAA8C;AAAA,UAC/D,QAAQ;AAAA,UACR,MAAM;AAAA,YACL,WAAW,SAAS;AAAA,YACpB,OAAO;AAAA,YACP,WAAW,qBAAqB;AAAA,UAChC;AAAA,QACN,CAAK;AAED,YAAI,QAAQ,KAAK,aAAa;AAC7BA,wBAAAA,MAAI,eAAe,SAAS,KAAK,WAAW;AAC5CA,wBAAAA,MAAI,eAAe,UAAU,KAAK,MAAM;AACxCA,wBAAAA,MAAA,MAAA,OAAA,wBAAY,mBAAmB;AAC/B,kBAAQ,IAAI;AACZ;AAAA,QACA;AAAA,MACD;AAAA,IACD,SAAQ,GAAG;AACXA,oBAAA,MAAA,MAAA,SAAA,wBAAc,qBAAqB,CAAC;AAAA,IACvC,UAAY;AACT,qBAAe;AAAA,IACf;AACD,YAAQ,KAAK;AAAA,EACf,CAAE;AAED,SAAO;AACR;;;;;"}